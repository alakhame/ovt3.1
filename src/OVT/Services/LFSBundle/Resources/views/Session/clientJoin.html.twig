<!doctype html>
<html>
    <head>
        <title>Session</title>
        <link rel="stylesheet" type="text/css" href="{{asset('ress/css/transcript.css')}}" />
        <link rel="stylesheet" href="{{asset('ress/css/bootstrap.css')}}" /> 
        <script src="{{asset('ress/js/angular.js')}}" > </script>
        <script src="{{asset('ress/js/jquery.js')}}" > </script>
        <script src="{{ asset('bundles/fosjsrouting/js/router.js') }}"></script>
        <script src="{{ path('fos_js_routing_js', {"callback": "fos.Router.setData"}) }}"></script> 
        <script src="{{asset('ress/js/simplewebrtc.bundle.js')}}" > </script>
    	<style>
            #remoteVideos video {
            	width:100%;
				height: 100%;
				position:relative
				top:0;
				left:0;
               
            }
            #localVideo { 
            	height: 150px;   
            	position:relative ;
            	z-index: 10;     
           	}
        </style>
	</head>
    <body>
        <div id="wrapper"  ng-app="OVTApp" ng-controller="LFSClientCtrl" data-ng-init="init()">
            <div id="incomingText"  >
                <div class="topDiv">
                    Transcription
                </div> 
                <div id="ttarea">
                        <div id="remoteVideos"></div>  
                         <video id="localVideo"></video>
                </div>
            </div>

            <div id ="infoSession">
                <div class="topDiv">
                    Details de la Session
                </div>
                <div class="detailsSession" style="overflow: scroll;"> 
                    <table id="newtable" class="table table-bordered table-striped  "> 
                        <tbody>
                            <tr>
                                <td colspan="0"> 
                                    <div  >
                                        Connecté en tant que :
                                    </div>                                     
                                </td>
                            </tr>
                            <tr>
                                <td colspan="0"> 
                                    <div  >
                                        {{user.firstName ~" "~user.lastName}}
                                    </div>                                     
                                </td>
                            </tr>
                            <tr>
                                <td colspan="0"> 
                                    <div  >
                                        Intitulé :
                                    </div>                                     
                                </td>
                            </tr>
                            <tr>
                                <td colspan="0"> 
                                    <div  >
                                        {{session.title}}
                                    </div>                                     
                                </td>
                            </tr>
                            <tr>
                                <td colspan="0"> 
                                    <div  >
                                        Organisateur :
                                    </div>                                     
                                </td>
                            </tr>
                            <tr>
                                <td colspan="0"> 
                                    <div  >
                                        {{session.client.user.firstName ~" "~session.client.user.lastName}}
                                    </div>                                     
                                </td>
                            </tr>
                             <tr>
                                <td colspan="0"> 
                                    <div  >
                                        Transcripteur :
                                    </div>                                     
                                </td>
                            </tr>
                            <tr>
                                <td colspan="0"> 
                                    <div  >
                                        {{session.worker.user.firstName ~" "~session.worker.user.lastName}}
                                    </div>                                     
                                </td>
                            </tr>
                             <tr>
                                <td colspan="0"> 
                                    <div  >
                                        Heure de début :
                                    </div>                                     
                                </td>
                            </tr>
                            <tr>
                                <td colspan="0"> 
                                    <div  >
                                        {{session.starttime|date('Y-m-d H:i:s') }}
                                    </div>                                     
                                </td>
                            </tr>
                            <tr>
                                <td colspan="0"> 
                                    <div  >
                                        Heure de fin :
                                    </div>                                     
                                </td>
                            </tr>
                            <tr>
                                <td colspan="0"> 
                                    <div  >
                                        {{session.endtime|date('Y-m-d H:i:s') }}
                                    </div>                                     
                                </td>
                            </tr>
                            <tr>
                                <td colspan="0"> 
                                    <div  >
                                        Détails supplémentaires :
                                    </div>                                     
                                </td>
                            </tr>
                            <tr>
                                <td colspan="0"> 
                                    <textarea readonly >
                                        {{session.description }}
                                    </textarea>                                     
                                </td>
                            </tr>
                        </tbody>    
                    </table>            

                </div>
            </div>

            <div id="chatBox" ng-controller="ChatClientCtrl">
                <div class="topDiv">
                    Messagerie instannée
                </div>
                <div id="msgBox" style="overflow: scroll;"></div>
                <div id="inputMsg">
                    <input type="text" id="chatField" class="col-md-9"></input>
                    <input type="submit" id="chatSender" class="col-md-3"value="Envoyer"></input>
                </div>
            </div>
        </div>

 
        <!--- ****************************** SEPARATOR *************************  -->
        <script src="{{asset('ress/js/socket.io.min.js')}}"></script>
        <script src="{{asset('ress/js/keycodes.js')}}"></script>
        <script type="text/javascript" src="{{asset('ress/js/socket.js')}}"></script>        
        <script type="text/javascript">
        	var app = angular.module('OVTApp', ['btford.socket-io']);
            
            app.factory('clientSocket', function (socketFactory) {
               return socketFactory({ 
                    ioSocket: io.connect("{{TRANSCRIPTING_SERVER}}", {'sync disconnect on unload': true })
                  });
            }).
            controller('LFSClientCtrl', function(clientSocket,$scope,$http,$location,$window) {
	            var webrtc;
            	function initChatBox (){
                    var link = Routing.generate('ovt_services_velotypie_API_get_chat_by_session_id',{sessionID:{{session.id}}});
                    var chatMessages; 
                    $http.get(link).
                    success(function(data, status, headers, config) {
                        chatMessages = data;
                        for(var i = 0; i<chatMessages.length; i++ ){
                        if(chatMessages[i].sender=={{user.id}}){
                            $('#msgBox').append('<div  > <span class="spanBlue">Moi :  </span>'+decodeURIComponent(chatMessages[i].content)+'</div>');
                        }
                        else{
                            $('#msgBox').append('<div> <span class="spanRed">Transcripteur :  </span>'+decodeURIComponent(chatMessages[i].content)+'</div>');
                        }
                    }
                    }).
                    error(function(data, status, headers, config) { }); 
                    
 
                }

                $scope.init = function (){
                    var link = Routing.generate('ovt_services_velotypie_API_get_content_by_id',{sessionID:{{session.id}}});
                    $http.get(link).
                    success(function(data, status, headers, config) {
                         $scope.textareaField = data;

                    }).
                    error(function(data, status, headers, config) { });
                    initChatBox()

                }

                                //////////// authentification handler /////////////////

                
                clientSocket.on("connect", function(){
                    //clientSocket.emit('letMeJoin',dataConnect);
                    var dataConnect={userID: "{{user.id}}",  saloon:"{{link}}"};
                    clientSocket.emit('clientJoin',dataConnect);
                    clientSocket.emit('clientPresence',dataConnect);
                });

                clientSocket.on("accessGranted", function(id){
                    alert('le serveur a accepté la connextion pour '+id);
                });

                clientSocket.on("accessDenied", function(id){
                     alert('l\'access a été refusée par le serveur pour '+id);
                });

 			
 				webrtc = new SimpleWebRTC({
				    localVideoEl: 'localVideo',
				    remoteVideosEl: 'remoteVideos',
				    autoRequestMedia: true ,
				    url:'{{TRANSCRIPTING_SERVER}}'
				}); 
	           	webrtc.on('readyToCall', function () {
				    webrtc.joinRoom('{{link}}');
				});

            });




        </script> 

        <script>
        	 //// CHAT HANDLER 
        	app.controller('ChatClientCtrl', function(clientSocket,$scope,$http,$location,$window) {
        		function sendChatMessage(data){
                    //console.log(data);
                    $('#msgBox').append('<div  > <span class="spanBlue">Moi :  </span>'+decodeURIComponent(data.content)+'</div>');
                    clientSocket.emit('newChatMessage',data);
                    $('#chatField').val("");
                } 

	            $('#chatSender').click(function(){
	                data={
	                    saloon : "{{link}}",
	                    session:{{session.id}},
	                    sender : {{session.client.user.id }},
	                    receiver : {{session.worker.user.id}},
	                   content:  encodeURIComponent($('#chatField').val()) 
	                };
	                sendChatMessage(data);
	            });
	            $('#chatField').bind("keydown", function(e){
	                if(e.keyCode==KeyCode.RETURN){
	                    data={
	                        saloon : "{{link}}",
	                        session:{{session.id}},
	                        sender : {{session.client.user.id}},
	                        receiver : {{session.worker.user.id}},
	                        content: encodeURIComponent($('#chatField').val()) 
	                    };
	                    sendChatMessage(data);
	                }
	            });
	        });
         </script>


    </body>
</html>
